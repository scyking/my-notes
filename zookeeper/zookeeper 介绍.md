# zookeeper 介绍

标签（空格分隔）： zookeeper

---

[toc]

## 概述

> ZooKeeper 是⼀个分布式的，开源的分布式应⽤程序协调服务。

### Session

> 指的是 ZooKeeper 服务器与客户端会话。
> 客户端启动的时候，会与服务器建立一个 `TCP` 连接。客户端会话的生命周期，从第一次建立 `TCP` 连接开始。
> 服务端在为客户端创建会话之前，会为每个客户端都分配一个 `sessionID`。`sessionID` 保持全局唯一。

### ZNode

> 数据模型中的数据单元。
> ZooKeeper 将所有数据存储在内存中，数据模型是一棵**树**（Znode Tree)，由斜杠（`/`）的进行分割的路径，就是一个 Znode。例如，`/foo/path1`。

- 持久节点(Persistent)
    > 客⼾端与zookeeper服务端断开连接后，该节点仍然存在。
- 持久有序节点(Persistent_sequential)
    > 在持久节点基础上，由zookeeper给该节点名称进⾏有序编号，如`0000001`，`0000002`。
- 临时节点(Ephemeral)
    > 客⼾端与zookeeper服务端断开连接后，该节点被删除。临时节点下，不存在⼦节点。
- 临时有序节点(Ephemeral_sequential)
    > 在临时节点基础上，由zookeeper给该节点名称进⾏有序编号，如`0000001`，`0000002`。

### 数据版本

> Zookeeper 的每个 `ZNode` 上都会存储数据，对应于每个 `ZNode`，Zookeeper 都会为其维护一个叫作 `Stat` 的数据结构。

`Stat` 中记录了 `ZNode` 的三个数据版本，分别是：

- version（当前 `ZNode` 的版本）
- cversion（当前 `ZNode` 子节点的版本）
- aversion（当前 `ZNode` 的 ACL 版本）

### Watcher

> 事件监听器。
> ZooKeeper 允许用户在指定节点上注册一些 `Watcher`，并且在一些特定事件触发的时候，ZooKeeper 服务端会将事件通知到感兴趣的客户端上去。该机制是 ZooKeeper 实现分布式协调服务的重要特性。

### ACL

> ZooKeeper 采用 ACL（`AccessControlLists`）策略来进行权限控制，类似于 UNIX 文件系统的权限控制。

五种权限：

- `CREATE`：创建**子节点**的权限。
- `READ`：获取节点数据和子节点列表的权限。
- `WRITE`：更新节点数据的权限。
- `DELETE`：删除**子节点**的权限。
- `ADMIN`：设置节点ACL的权限。

## 功能

- 文件系统
- 通知机制

### 命名服务（⽂件系统）

> 通过指定的名字来获取资源或者服务的地址，利⽤zk创建⼀个全局的路径，即是唯⼀的路径，这个路径就可以作为⼀个名字，指向集群中的集群，提供的服务的地址，或者⼀个远程的对象等等。

### 配置管理（⽂件系统、通知机制）

> 程序分布式的部署在不同的机器上，将程序的配置信息放在zk的 `znode` 下，当有配置发⽣改变时，也就是 `znode` 发⽣变化时，可以通过改变zk中某个⽬录节点的内容，利⽤ `watcher` 通知给各个客⼾端，从⽽更改配置。

### 集群管理（⽂件系统、通知机制）

- 机器退出和加⼊
    > 所有机器约定在⽗⽬录下创建临时⽬录节点，然后监听⽗⽬录节点的⼦节点变化消息。⼀旦有机器挂掉，该机器与 zookeeper 的连接断开，其所创建的临时⽬录节点被删除，所有其他机器都收到通知：“某个兄弟⽬录被删除”。新机器加入，原理类似。
- 选举 master
    > 所有机器创建临时顺序编号⽬录节点，可以每次选取编号最⼩的机器作为 master。

## 特点

- **顺序一致性**：从同一客户端发起的事务请求，最终将会严格地按照顺序被应用到 ZooKeeper 中去。
- **原子性**：所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，也就是说，要么整个集群中所有的机器都成功应用了某一个事务，要么都没有应用。
- **单一系统映像**：无论客户端连到哪一个 ZooKeeper 服务器上，其看到的服务端数据模型都是一致的。
- **可靠性**：一旦一次更改请求被应用，更改的结果就会被持久化，直到被下一次更改覆盖。

## 工作过程

1. 业务进程启动后与 zookeeper 建⽴连接
1. 在 zookeeper ⾥创建临时节点并写⼊该业务进程的相关信息
1. 通过周期性的⼼跳和 zookeeper 保持住连接
1. 如果，zookeeper 一段时间收不到心跳，将会删除与之对应的临时节点，表⽰这个业务进程不再可⽤。

## 使用场景

- 分布式协调（消息队列）
- 分布式锁
- 元数据/配置信息管理
- HA⾼可⽤性

### 分布式锁实现原理

> 重复以下步骤，保证多个进程获取同⼀个锁，且只有⼀个进程能获得锁。

1. 根据 zookeeper 有序临时节点的特性，每个进程对应连接⼀个有序临时节点（进程1对应节点`/znode/00000001`，进程2对应节点`/znode/00000002`…）。每个进程监听对应的上⼀个节点的变化。编号最⼩的节点对应的进程获得锁，可以操作资源。
1. 当进程1完成业务后，删除对应的⼦节点`/znode/00000001`，释放锁。此时，编号最⼩的锁便获得锁（即`/znode/00000002`对应进程）。

### 服务注册与发现

#### 服务注册原理

> rpc框架会在 zookeeper 的注册⽬录下，为每个应⽤创建⼀个持久节点。然后，在对应的持久节点下，为每个微服务创建⼀个临时节点，记录每个服务的URL等信息。

#### 服务动态发现原理

> 由于**服务消费⽅**向 zookeeper 订阅了（监听）服务提供⽅，⼀旦**服务提供⽅**有变动的时候（增加服务或者减少服务），zookeeper 就会把最新的服务提供⽅列表推送给**服务消费⽅**。
