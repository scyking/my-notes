# mysql 读写分离

标签（空格分隔）： mysql

---

[toc]

## 实现方式
> 基于主从复制架构。⼀个主库，挂多个从库，然后只写主库，主库会⾃动把
数据给同步到从库上去。

## 原理
> 主库将变更写⼊ `binlog` ⽇志，然后从库连接到主库之后，从库有⼀个 IO 线程，将主库的 `binlog` ⽇志拷⻉到⾃⼰本地，写⼊⼀个 `relay` 中继⽇志中。接着从库中有⼀个 SQL 线程会从中继⽇志读取 `binlog`，然后执⾏ `binlog` ⽇志中的内容，也就是在⾃⼰本地再次执⾏⼀遍 SQL，这样就可以保证⾃⼰跟主库的数据是⼀样的。

## 问题

### 主从同步延时问题
> 从库同步主库数据的过程是串⾏化的，即主库上并⾏的操作，在从库上会串⾏执⾏。所
以，由于从库从主库拷⻉⽇志以及串⾏执⾏ SQL 的特点，在⾼并发场景下，从库的数据⼀定会⽐主库
慢⼀些，是有延时的。所以经常出现，刚写⼊主库的数据可能是读不到的，要过⼏⼗毫秒，甚⾄⼏百毫秒才能读取到。

### 主库数据丢失问题
> 如果主库突然宕机，然后恰好数据还没同步到从库，那么有些数据可能在从库上是没有的，有
些数据可能就丢失了。

### 解决方案
> MySQL 实际上在这⼀块有两个机制，⼀个是半同步复制，⽤来解决主库数据丢失问题；⼀个是并⾏复制，⽤来解决主从同步延时问题。

- 并⾏复制
> 指的是从库开启多个线程，并⾏读取 `relay` 日志中不同库的⽇志，然后并⾏重放不同库的⽇志，这是库级别的并
⾏。

- 半同步复制
> 也叫 `semi-sync` 复制，指的就是主库写⼊ `binlog` ⽇志之后，就会将强制此时⽴即将数据同步到从库，从库将⽇志写⼊⾃⼰本地的 `relay` 日志之后，接着会返回⼀个 `ack` 给主库，主库接收到⾄少⼀个从库的 `ack` 之后才会认为写操作完成了。


