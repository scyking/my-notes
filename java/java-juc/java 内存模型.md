# java 内存模型

---

[toc]

## 概述

> java内存模型（JMM，Java Memory Model）规定了线程和内存之间的关系。
> 屏蔽了各种硬件和操作系统的访问差异，保证了Java程序在各种平台下对内存的访问都能保证效果一致。

### 主要目的

> 解决由于多线程通过**共享内存**进行通信时，存在的本地内存数据不一致、编译器会对代码指令重排序、处理器会对代码乱序执行等带来的问题。
> 可以保证并发编程场景中的**原子性**、**可见性**和**有序性**。

### 原子性（Atomicity）

> 指一个操作是不可中断的，即使是在多个线程一起执行的情况下，一个操作一旦开始执行，就不会受到其他线程的干扰。

### 可见性（Visibility）

> 指在多线程情况下，当一个线程修改了某一个共享变量的值之后，其他线程是否能够立即知道这个修改。

### 有序性（Ordering）

> 程序在执行时，可能因为编译器优化的缘故，进行了指令重排的操作，重排后的指令与原指令的顺序未必一致。
> 指令重排可以保证串行语义一致，但是没有义务保证多线程间的语义也一致。

## 重排序

## 顺序一致性

## `happens-before`规则

- 程序顺序原则：一个线程内保证语义的串行性
- volatile规则：`volatile`变量的写操作，先发生于读操作，这保证了`volatile`变量的可见性
- 锁规则：解锁（`unlock`）必然发生在随后的加锁（`lock`）前
- 传递性：A先于B，B先于C，那么A必然先于C
- 线程的`start()`方法先于它的每一个动作
- 线程的所有操作先于线程的终结（`Thread.join()`）
- 线程的中断（`interrupt`）先于被中断线程的代码
- 对象的构造函数执行、结束先于`finalize()`方法

## as-if-serial
