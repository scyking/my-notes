# java CAS

---

[toc]

## 概述

> `CAS`（`Compare And Swap`），整个`JUC`体系最核心、最基础理论。

### 处理方式

> 包含三个操作数：内存值（`V`）、预期原值（`A`）、新值（`B`）。
> 当且仅当 `V` 等于 `A` 才会将 `V` 修改为 `B`，否则不做任何处理，仅返回当前 `V` 值。

### `synchronized` 关键字问题

> `synchronized`是一种独占锁，会导致其它所有需要锁的线程挂起，等待持有锁的线程释放锁。

1. 在多线程竞争下，加锁、释放锁会导致比较多的上下文切换和调度延时，引起性能问题。
1. 一个线程持有锁会导致其它所有需要此锁的线程挂起。
1. 如果一个优先级高的线程等待一个优先级低的线程释放锁会导致优先级倒置，引起性能风险。

## 存在问题

### `ABA`问题

> 如果一个值原来是A，变成了B，又变成了A，那么使用CAS进行检查时会发现它的值没有发生变化，但是实际上却变化了。

解决方法：

- 添加版本号
- 使用`AtomicStampedReference`中`compareAndSet(V,V,int,int)`方法。

### 循环时间开销大

> 自旋CAS如果长时间不成功，会给CPU带来非常大的执行开销。

### 只能保证一个共享变量的原子操作

解决方法：

> `AtomicReference` 可以保证引用对象之间的原子性。因此，可以把多个变量放在一个对象里来进行CAS操作。
