# C10K 问题

---

[toc]

## 概述

> C10K 问题指的是**服务器如何支持10k个并发连接**。
> 最初的服务器是基于**进程/线程**模型。新到来一个TCP连接，就需要分配一个进程。假如有C10K，就需要创建1W个进程，单机是无法承受的。

### 问题本质

> 本质上是操作系统的问题，传统的同步阻塞I/O模型处理方式都是 `requests per second`。
> 当创建的进程或线程多了，数据拷贝频繁（缓存I/O、内核将数据拷贝到用户进程空间、阻塞），进程/线程上下文切换消耗大，导致操作系统崩溃。

### 解决方案

从网络编程技术的角度来说，主要思路：

- 每个连接分配一个独立的线程/进程（申请进程/线程是需要系统资源的，且系统需要管理这些进程/线程，所以会使资源占用过多，可扩展性差）
- 同一个线程/进程同时处理多个连接（I/O 多路复用）

## I/O 多路复用

### 传统思路

> 循环挨个处理各个连接，每个连接对应一个 `socket`。

- 思路
直接循环处理多个连接。
- 问题
任一文件句柄的不成功会阻塞住整个应用。

### `select`

> 为解决上面阻塞的问题，在读取文件句柄之前，先检查其状态。如果`ready` 则进行处理，否则不进行处理。

- 思路
有连接请求抵达了再检查处理。
- 问题
“句柄上限+重复初始化+逐个排查所有文件句柄状态”效率不高。

### `poll`

> 通过一个 `pollfd` 数组向内核传递需要关注的事件消除文件句柄上限，同时使用不同字段分别标注关注事件和发生事件，来避免重复初始化。

- 思路
设计新的数据结构提供使用效率。
- 问题
逐个排查所有文件句柄状态效率不高。

### `epoll`

> 调用返回时，只向应用提供状态发生变化的文件句柄进行排查。

- 思路
只返回状态变化的文件句柄。
- 问题
依赖特定平台（Linux）。
