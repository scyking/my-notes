# mysql 存储引擎

标签（空格分隔）： mysql

---

[toc]

## 概述
> 存储引擎，即表类型(table_type)，用户可以根据应用的需求选择如何来存储数据、索引、是否使用事务等。

## SQL 相关操作

### 查看当前表使用的存储引擎

```
-- emp是表名
mysql> show create table emp;
-- 或者
-- \G 表示将查询结果进行按列打印，可以使每个字段打印到单独的行。
mysql> show table status like 'emp' \G;
```

### 查看当前数据库支持的存储引擎

```
mysql> show engines \G;
```

### 定义存储引

- 在创建表的时候，在create语句最后加上`engine=innodb/...`
- 用alter table语句修改

    ```
    mysql> alter table emp engine=innodb;
    ```
    
## MyISAM
> MySQL5.5之前的默认存储引擎。

### 适用场景
> 对事务的完整性没有要求，或以`select`、`insert`为主的应用基本都可以选用`MYISAM`。在Web、数据仓库中应用广泛。

### 优点
> 访问速度快。

### 特点

1. 不支持事务、外键
1. 每个myisam在磁盘上存储为3个文件，文件名和表名相同，扩展名分别是
    - `.frm`，存储表定义
    - `.MYD`，MYData，存储数据
    - `.MYI`，MYIndex，存储索引

    数据文件和索引文件可以放在不同的目录，平均分布IO，加快访问速度，在创建表的时候通过`data directory`和`index directory`来指定存储路径。

1. myisam表还支持三种不同的存储格式
    - 静态表（fixed）
    默认的存储格式
    静态表中的字段都是非变长字段，每个记录都是固定的长度，当表不包含变量长度列(`VARCHAR`， `BLOB`或`TEXT`)时，使用这个格式。
    优点：存储迅速，出现故障容易恢复。
    缺点：占用空间比动态表大，静态表在进行数据存储时会按照事先定义的列宽度补足空格，但在访问的时候会去掉这些空格。
    注意：如果数据本身带有空格，在返回的时候会去掉数据本身自带的末尾的空格，前面的会保留。
    - 动态表（dynamic）
    包含变长字段，例如`varchar`、`text`、`blob`，如果一个MyISAM表包含任何可变长度的字段（`varchar`、`blob`、`text`），或者该表创建时用`row_format=dynamic`指定，则该表使用动态格式存储。
    优点：占用空间小。
    缺点：频繁的更新和删除操作会产生碎片，需要定期用`optimize table`语句或`myisamchk -r`命令来改善性能，并且在出现故障后较难恢复。
    - 压缩表
    由myisampack工具创建，占据非常小的磁盘空间，因为每个记录都是被单独压缩的

## InnoDB
> MySQL5.5之后的默认存储引擎。

### 适用场景
> 如果应用对事务的完整性有较高的要求，在并发条件下要求数据的一致性，数据操作中包含读、插入、删除、更新，那InnoDB是最好的选择。在计费系统、财务系统等对数据的准确性要求较高的系统中被广泛应用。

### 优点
> 提供了具有提交（Commit）、回滚（Rollback）、崩溃恢复能力的事务安全，支持外键。

### 缺点
> 相比较于MyISAM，写的处理效率差一点，并且会占用更多的磁盘空间来存储数据和索引

### 特点

#### 自动增长列
> innoDB表的自动增长列必须是索引，如果是组合索引，也必须是组合索引的第一列。
> MyISAM表的自动增长列可以是组合索引的其他列。
> 设置自动增长列：create表时，在字段后加`auto_increment`
> 可以通过`alter table emp auto_increment=n`来强制设置自动增长列的初始值，默认是1。但是该强制指定的值是保存在内存中的，所以在数据库重启后会失效，需要重新设置。

#### 外键约束
> MySQL的存储引擎中只有innoDB支持外键约束。
> 注意，当某个表被其它表创建了外键参照，那么该表对应的索引和主键禁止被删除。
> 当导入多个表的数据时，如果要忽略表之前导入顺序，或者当执行`load data`和`alter table`操作，为了提高处理速度的时候，可以暂时关闭外键约束，命令是`mysql> set foreign_key_checks=0;`。执行完之后，再使其为1 ，开启外键。

- 查看外键信息

    ```
    show create table 或show table status
    ```

#### 存储方式
> innoDB存储数据和索引有**共享表空间**存储和**独占表空间**存储两种方式，通过参数`innodb_file_per_table`控制，0表示共享空间，也是默认的，1表示独占空间。两种方式的表结构（描述）都保存在`.frm`文件中。

##### 共享表空间
> 每一个数据库的所有表的数据、索引都保存在一个文件中，默认在data目录下，名为`ibdata1`，大小为10M的文件，可以通过参数`innodn_data_file_path=/data/ibdata1:2000M`来指定存储路径。

- 优点
    1. 可以将表空间分为多个文件放在不同的磁盘上，分布IO，提高性能。`innodn_data_file_path=/data/ibdata1:2000M；/db/ibdata2:2000M:autoextend`，`autoextend`表示如果指定的2000M空间用满后，该文件自动增长。也就是说采用共享空间存储，存储空间的大小不受文件系统下文件大小的限制了，而取决于自身的限制，官方文档显示，表空间的最大限制是64TB。
    1. 表数据和表结构放在一起，方便管理。

- 缺点
    > 由于所有的数据和索引都是在一个文件中混合存储，这样的话对一个表做了大量的删除操作后，表空间中会产生大量的空隙。

##### 独占表空间存储：
> 每一张表都有自己独立的表空间，表的结构依然在`.frm`文件中，还有一个后缀为`.ibd`的文件，保存了这张表的数据和索引。

- 优点
    1. 每张表都有自己独立的表空间，可实现单表在不同数据库中移动
    1. 空间可回收。`drop table`会自动回收；删除数据后，通过`alter table emp engine=innodb`也可回收不用的表空间。
    1. 效率和性能会好一些

- 缺点
    > 由于每个表的数据都是以一个单独的文件来存放，所以会受到文件系统的大小限制。
