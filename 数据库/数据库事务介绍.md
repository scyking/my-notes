# 数据库事务介绍

标签：db

---

[toc]


> 事务，由一系列对系统数据的操作所组成的一个程序执行逻辑单元。

## 四大特性

- 原子性（`Atomicity`）
    事务中包含的所有操作要么全部成功，要么全部失败回滚。
- 一致性（`Consistency`）
    事务执行前和执行后必须处于一致性状态。
- 隔离性（`Isolation`）
    当多个用户并发访问数据库时，数据库为每一个用户开启的事务，不被其他事务的操作所干扰，多个并发事务之间要相互隔离。
- 持久性（`Durability`）
    一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便在数据库系统遇到故障的情况下也不会丢失事物的操作。
    
## 四大隔离级别

> 隔离级别越高，执行效率越低。
> MySQL默认隔离级别：可重复读。
> Oracle默认隔离级别：读已提交。仅支持`SERIALIZABLE`、`READ_COMMITED`。

- 读未提交（`READ_UNCOMMITTED`）
    最低级别，任何情况都会发生。
- 读已提交（`READ_COMMITED`）
    可避免脏读。
- 可重复读（`REPEATABLE_READ`）
    可避免脏读、不可重复读。
- 顺序读/串行化（`SERIALIZABLE`）
    最高隔离级别，可避免脏读、不可重复读、幻读。

### 并发问题

- 脏读（`Dirty Read`）
    一个事务处理过程里读取了另一个**未提交**的事务中的数据。
- 不可重复读（`Unrepeatable Read`）
    A事务读取了B事务**已提交**的更改（修改、删除）数据，导致两次读取该数据的结果不一致。
    对于不可重复读问题，可使用行锁解决。
- 幻读（`Phantom Read`）
    A事务读取B事务**已提交**的新增数据，导致两次读取该数据的结果不一致。
    对于幻读问题，可使用读写锁解决。

## 七大传播特性

> Spring 对JDBC的隔离级别作出了补充和扩展。

- `PROPAGATION_REQUIRED`：默认事务类型，如果没有，就新建一个事务；如果有，就加入当前事务。适合绝大多数情况。
- `PROPAGATION_REQUIRES_NEW`：如果没有，就新建一个事务；如果有，就将当前事务挂起。
- `PROPAGATION_NESTED`：如果没有，就新建一个事务；如果有，就在当前事务中嵌套其他事务。
- `PROPAGATION_SUPPORTS`：如果没有，就以非事务方式执行；如果有，就使用当前事务。
- `PROPAGATION_NOT_SUPPORTED`：如果没有，就以非事务方式执行；如果有，就将当前事务挂起。即无论如何不支持事务。
- `PROPAGATION_NEVER`：如果没有，就以非事务方式执行；如果有，就抛出异常。
- `PROPAGATION_MANDATORY`：如果没有，就抛出异常；如果有，就使用当前事务。

PS：事务挂起：需要新事务时，将当前连接保存，操作新连接事务结束后，再取出操作。保存连接的动作称为事务挂起。

## 普通事务与`XA`事务区别

- 普通事务
只支持一个数据库连接，不能跨越多个数据库。默认的情况为自动提交事务，也就是说，每一条对数据库的更新的sql语句代表一项事务，操作成功后，系统自动调用`commit`来提交，否则将调用`rollback`来撤消事务。

- `XA`事务
支持在两个或多个网络计算机资源上访问并且更新数据，这些数据可以分布在多个数据库上。

PS：`XA`，由`X/Open`组织提出的分布式事务的规范。

## CAP定理

- `Consistency`：一致性
- `Availability`：可用性
- `Partition Tolerance`：分区容忍性

### BASE理论
> BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性，但每个应用都可以根据自身的业务特点，采用适当的方法来使系统达到最终一致性。

- `Basically Available`，基本可用
- `Soft state`，软状态
- `Eventually consistent`，最终一致性

### 数据一致性模型

- 强一致性，当更新操作完成之后，任何多个后续进程或者线程的访问都会返回最新的更新过的值。
- 弱一致性，系统并不保证续进程或者线程的访问都会返回最新的更新过的值。
- 最终一致性，是弱一致性的一种特例。系统保证在没有后续更新的前提下，系统最终返回上一次更新操作的值。

### 数据一致性协议

- 2PC，请求处理-->提交确认
- 3PC，事务处理能力询问-->处理后待提交-->提交确认

## java 事务类型

1. JDBC 事务，局限在一个数据库连接内。
    - `setAutoCommit(boolean)`：设置是否自动提交事务。`true`表示每条执行SQL都是单独的事务，`false`表示开启事务。
    - `commit()`：提交结束事务。
    - `rollback()`：回滚结束事务。
1. JTA（`Java Transaction API`）事务，java提供的可用于分布式事务的一套API。实现复杂，限制代码复用性。
1. 容器事务，主要指J2EE应用服务器提供的事务管理，局限于EJB应用使用。
